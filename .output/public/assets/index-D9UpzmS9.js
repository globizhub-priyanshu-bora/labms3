import{R as ne,r as a,u as M,t as r,j as e,B as n,b as k,X as H,L as p,d as oe,s as me,e as xe,f as he,h as pe,i as ue,k as ye}from"./main-U2sX-pZG.js";import{L as ge}from"./Layout-gOgl803z.js";import{P as be}from"./plus-3bSggh7o.js";import{S as fe}from"./search-C16oIlKW.js";import{S as je,T as Ne}from"./trash-2-DVrQfetj.js";function ke(){const o=ne.useLoaderData(),[J,K]=a.useState(o?.tests?.data||[]),[m,W]=a.useState(o?.parameters?.data||[]),[Y,b]=a.useState(!1),[Z,f]=a.useState(!1),[C,_]=a.useState(null),[L,E]=a.useState(""),[B,x]=a.useState([]),[A,u]=a.useState(!1),[j,N]=a.useState(null),[l,d]=a.useState([]),[v,c]=a.useState("0.00"),[y,O]=a.useState(""),[w,R]=a.useState([]),{register:$,handleSubmit:ee,reset:Q,setValue:V,formState:{errors:S,isSubmitting:D}}=M(),{register:U,handleSubmit:se,reset:te,setValue:z,formState:{errors:P,isSubmitting:G}}=M(),{register:re,handleSubmit:ae}=M();a.useEffect(()=>{o?.error&&(N(o.error),r.error(o.error))},[o?.error]),a.useEffect(()=>{if(y){const s=m.filter(t=>t.name.toLowerCase().includes(y.toLowerCase()));R(s)}else R(m)},[y,m]),a.useEffect(()=>{(async()=>{if(l.length===0){c("0.00");return}try{const t=await oe({data:{parameterIds:l}});t.success&&(c(t.totalPrice),V("price",t.totalPrice))}catch(t){console.error("Error calculating price:",t)}})()},[l,V]);const F=async()=>{try{const s=await ye({data:{limit:100,offset:0,sortBy:"name",sortOrder:"asc"}});s.success&&K(s.data)}catch(s){console.error("Error loading tests:",s),r.error("Failed to load tests")}},X=async()=>{try{const s=await he({data:{limit:100,offset:0,sortBy:"name",sortOrder:"asc"}});s.success?(W(s.data),N(null)):(r.error("Failed to load test parameters"),N("Failed to load test parameters"))}catch(s){const t=s instanceof Error?s.message:"Failed to load test parameters";console.error("Error loading parameters:",s),r.error(t),N(t)}},T=s=>{d(t=>t.includes(s)?t.filter(i=>i!==s):[...t,s])},le=async s=>{if(!s.name.trim()){r.error("Test name is required");return}if(!s.price||parseFloat(s.price)<=0){r.error("Please enter a valid price");return}if(l.length===0){r.error("Please select at least one parameter");return}try{const t=await pe({data:{name:s.name,price:s.price,parameterIds:l}});t.success?(r.success("Test created successfully"),Q(),d([]),c("0.00"),b(!1),await F()):r.error(t.error||"Failed to create test")}catch(t){const i=t instanceof Error?t.message:"Failed to create test";console.error("Error creating test:",t),r.error(i)}},ce=async s=>{if(!C){r.error("No test selected");return}if(!s.name.trim()){r.error("Test name is required");return}if(!s.price||parseFloat(s.price)<=0){r.error("Please enter a valid price");return}if(l.length===0){r.error("Please select at least one parameter");return}try{const t=await ue({data:{id:C.id,name:s.name,price:s.price,parameterIds:l}});t.success?(r.success("Test updated successfully"),te(),d([]),c("0.00"),f(!1),await F()):r.error(t.error||"Failed to update test")}catch(t){const i=t instanceof Error?t.message:"Failed to update test";console.error("Error updating test:",t),r.error(i)}},ie=async s=>{if(confirm("Are you sure you want to delete this test?"))try{const t=await xe({data:{id:s}});t.success?(r.success("Test deleted successfully"),await F()):r.error(t.error||"Failed to delete test")}catch(t){const i=t instanceof Error?t.message:"Failed to delete test";console.error("Error deleting test:",t),r.error(i)}},de=async s=>{if(!s.query.trim()){x([]),u(!1);return}u(!0);try{const t=await me({data:{query:s.query,limit:50,offset:0}});t.success?x(t.data):(r.error("Failed to search tests"),x([]))}catch(t){const i=t instanceof Error?t.message:"Failed to search tests";console.error("Error searching tests:",t),r.error(i),x([])}finally{u(!1)}},q=B.length>0?B:J;return e.jsx(ge,{children:e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsx("div",{className:"bg-white border border-gray-300 mb-4 p-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Test Management"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[q.length," test(s) ",A&&`for "${L}"`]})]}),e.jsxs(n,{onClick:()=>{b(!0),d([]),c("0.00"),Q()},className:"bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Add Test"]})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-4 gap-4",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white border border-gray-300 p-4",children:[e.jsx("h2",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Search Tests"}),e.jsxs("form",{onSubmit:ae(de),children:[e.jsx("input",{type:"text",placeholder:"Search...",...re("query"),onChange:s=>E(s.target.value),className:"w-full px-3 py-2 border border-gray-300 text-sm mb-2"}),e.jsxs("button",{type:"submit",className:"w-full px-3 py-2 bg-white border border-gray-400 text-gray-900 text-sm hover:bg-gray-50",children:[e.jsx(fe,{className:"w-4 h-4 inline mr-1"}),"Search"]})]}),A&&e.jsx(n,{onClick:()=>{u(!1),x([]),E("")},className:"w-full mt-2 px-3 py-2 text-sm",children:"Clear Search"})]})}),e.jsx("div",{className:"lg:col-span-3",children:e.jsx("div",{className:"bg-white border border-gray-300",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-gray-300 bg-gray-50",children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-gray-900",children:"Test Name"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-gray-900",children:"Price (₹)"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold text-gray-900",children:"Parameters"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-900",children:"Actions"})]})}),e.jsx("tbody",{children:q.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:4,className:"px-4 py-12 text-center",children:A?e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(k,{className:"w-12 h-12 text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-700 font-medium text-base",children:"No tests found"}),e.jsxs("p",{className:"text-gray-500 text-sm mt-1",children:['No results for "',L,'"']}),e.jsx(n,{onClick:()=>{u(!1),x([]),E("")},className:"mt-3 px-4 py-2 text-sm",children:"Clear Search"})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsx(k,{className:"w-12 h-12 text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-700 font-medium text-base",children:"No tests created yet"}),e.jsx("p",{className:"text-gray-500 text-sm mt-1",children:"Get started by adding your first test"})]})})}):q.map(s=>{const i=(s.metadata?.parameterIds||[]).map(g=>m.find(h=>h.id===g)?.name||"Unknown").join(", ");return e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-gray-900 font-medium",children:s.name}),e.jsxs("td",{className:"px-4 py-3 text-gray-700",children:["₹",s.price]}),e.jsx("td",{className:"px-4 py-3 text-gray-700 text-xs",children:i||"-"}),e.jsxs("td",{className:"px-4 py-3 text-center",children:[e.jsx("button",{onClick:()=>{_(s);const g=s.metadata?.parameterIds||[];d(g),z("name",s.name),z("price",s.price),f(!0);const I=async()=>{if(g.length===0){c("0.00");return}try{const h=await I({data:{parameterIds:g}});h.success&&c(h.totalPrice)}catch(h){console.error("Error calculating price:",h)}};I()},className:"text-blue-600 hover:text-blue-800 mr-3 inline",children:e.jsx(je,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ie(s.id),className:"text-red-600 hover:text-red-800 inline",children:e.jsx(Ne,{className:"w-4 h-4"})})]})]},s.id)})})]})})})})]}),Y&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white border border-gray-400 max-w-3xl w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-300 bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Add Test Bundle"}),e.jsx(n,{variant:"destructive",onClick:()=>{b(!1),d([]),c("0.00")},className:"p-1",children:e.jsx(H,{className:"w-4 h-4"})})]}),e.jsxs("form",{onSubmit:ee(le),className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(p,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Test Name *"}),e.jsx("input",{type:"text",...$("name",{required:"Test name is required"}),className:"w-full px-3 py-2 border border-gray-300 text-sm"}),S.name&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:S.name.message})]}),e.jsxs("div",{children:[e.jsx(p,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Price (₹) *"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",...$("price",{required:"Price is required"}),className:"flex-1 px-3 py-2 border border-gray-300 text-sm",placeholder:`Calculated: ${v}`})}),S.price&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:S.price.message}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Calculated: ₹",v]})]})]}),e.jsxs("div",{className:"border-t border-gray-300 pt-4",children:[e.jsxs(p,{className:"block text-sm font-medium text-gray-900 mb-2",children:["Select Parameters (",l.length," selected)"]}),j&&e.jsxs("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm flex items-start gap-2",children:[e.jsx(k,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:j}),e.jsx("button",{type:"button",onClick:X,className:"text-red-600 hover:text-red-800 underline",children:"Try loading parameters again"})]})]}),e.jsx("input",{type:"text",placeholder:"Search parameters...",value:y,onChange:s=>O(s.target.value),className:"w-full px-3 py-2 border border-gray-300 text-sm mb-3"}),e.jsx("div",{className:"border border-gray-300 max-h-64 overflow-y-auto",children:w.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:m.length===0?"No parameters available. Please create test parameters first.":"No parameters match your search"}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900 w-12",children:"Select"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Parameter"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Unit"}),e.jsx("th",{className:"px-3 py-2 text-right font-semibold text-gray-900",children:"Price"})]})}),e.jsx("tbody",{children:w.map(s=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 cursor-pointer",onClick:()=>T(s.id),children:[e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:l.includes(s.id),onChange:()=>T(s.id),className:"w-4 h-4"})}),e.jsx("td",{className:"px-3 py-2 text-gray-900",children:s.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:s.unit||"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-900",children:s.price?`₹${s.price}`:"-"})]},s.id))})]})})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(n,{type:"button",variant:"destructive",onClick:()=>{b(!1),d([]),c("0.00")},className:"flex-1 px-3 py-2 text-sm",children:"Cancel"}),e.jsx(n,{type:"submit",disabled:D,className:"flex-1 px-3 py-2 text-sm",children:D?"Adding...":"Add Test"})]})]})]})}),Z&&C&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white border border-gray-400 max-w-3xl w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-300 bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Test Bundle"}),e.jsx(n,{onClick:()=>{f(!1),d([]),c("0.00")},className:"p-1 bg-white border border-gray-400",children:e.jsx(H,{className:"w-4 h-4"})})]}),e.jsxs("form",{onSubmit:se(ce),className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(p,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Test Name *"}),e.jsx("input",{type:"text",...U("name",{required:"Test name is required"}),className:"w-full px-3 py-2 border border-gray-300 text-sm"}),P.name&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:P.name.message})]}),e.jsxs("div",{children:[e.jsx(p,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Price (₹) *"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",...U("price",{required:"Price is required"}),className:"flex-1 px-3 py-2 border border-gray-300 text-sm",placeholder:`Calculated: ${v}`})}),P.price&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:P.price.message}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Calculated: ₹",v]})]})]}),e.jsxs("div",{className:"border-t border-gray-300 pt-4",children:[e.jsxs(p,{className:"block text-sm font-medium text-gray-900 mb-2",children:["Select Parameters (",l.length," selected)"]}),j&&e.jsxs("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm flex items-start gap-2",children:[e.jsx(k,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:j}),e.jsx("button",{type:"button",onClick:X,className:"text-red-600 hover:text-red-800 underline",children:"Try loading parameters again"})]})]}),e.jsx("input",{type:"text",placeholder:"Search parameters...",value:y,onChange:s=>O(s.target.value),className:"w-full px-3 py-2 border border-gray-300 text-sm mb-3"}),e.jsx("div",{className:"border border-gray-300 max-h-64 overflow-y-auto",children:w.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:m.length===0?"No parameters available. Please create test parameters first.":"No parameters match your search"}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900 w-12",children:"Select"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Parameter"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Unit"}),e.jsx("th",{className:"px-3 py-2 text-right font-semibold text-gray-900",children:"Price"})]})}),e.jsx("tbody",{children:w.map(s=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 cursor-pointer",onClick:()=>T(s.id),children:[e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:l.includes(s.id),onChange:()=>T(s.id),className:"w-4 h-4"})}),e.jsx("td",{className:"px-3 py-2 text-gray-900",children:s.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:s.unit||"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-900",children:s.price?`₹${s.price}`:"-"})]},s.id))})]})})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(n,{type:"button",variant:"destructive",onClick:()=>{f(!1),d([]),c("0.00")},className:"flex-1 px-3 py-2 text-sm",children:"Cancel"}),e.jsx(n,{type:"submit",disabled:G,className:"flex-1 px-3 py-2 text-sm",children:G?"Saving...":"Save Changes"})]})]})]})})]})})}export{ke as component};
