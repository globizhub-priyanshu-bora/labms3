import{R as ie,r as a,u as A,t as r,j as e,B as n,b as F,X as U,L as h,d as z,s as de,e as ne,f as oe,h as me,i as xe,k as he}from"./main-B5l_WD0C.js";import{L as ue}from"./Layout-I5whc15b.js";import{P as pe}from"./plus-B1l9sOiB.js";import{S as ge}from"./search-eLbCl2GW.js";import{S as ye,T as be}from"./trash-2-dKfabO69.js";function ke(){const o=ie.useLoaderData(),[X,G]=a.useState(o?.tests?.data||[]),[m,H]=a.useState(o?.parameters?.data||[]),[J,u]=a.useState(!1),[K,y]=a.useState(!1),[T,W]=a.useState(null),[fe,je]=a.useState(""),[q,b]=a.useState([]),[Ne,k]=a.useState(!1),[f,j]=a.useState(null),[c,d]=a.useState([]),[N,l]=a.useState("0.00"),[p,I]=a.useState(""),[v,M]=a.useState([]),{register:L,handleSubmit:Y,reset:E,setValue:B,formState:{errors:w,isSubmitting:O}}=A(),{register:R,handleSubmit:Z,reset:_,setValue:Q,formState:{errors:S,isSubmitting:V}}=A(),{register:ee,handleSubmit:te}=A();a.useEffect(()=>{o?.error&&(j(o.error),r.error(o.error))},[o?.error]),a.useEffect(()=>{if(p){const t=m.filter(s=>s.name.toLowerCase().includes(p.toLowerCase()));M(t)}else M(m)},[p,m]),a.useEffect(()=>{(async()=>{if(c.length===0){l("0.00");return}try{const s=await z({data:{parameterIds:c}});s.success&&(l(s.totalPrice),B("price",s.totalPrice))}catch(s){console.error("Error calculating price:",s)}})()},[c,B]);const C=async()=>{try{const t=await he({data:{limit:100,offset:0,sortBy:"name",sortOrder:"asc"}});t.success&&G(t.data)}catch(t){console.error("Error loading tests:",t),r.error("Failed to load tests")}},$=async()=>{try{const t=await oe({data:{limit:100,offset:0,sortBy:"name",sortOrder:"asc"}});t.success?(H(t.data),j(null)):(r.error("Failed to load test parameters"),j("Failed to load test parameters"))}catch(t){const s=t instanceof Error?t.message:"Failed to load test parameters";console.error("Error loading parameters:",t),r.error(s),j(s)}},P=t=>{d(s=>s.includes(t)?s.filter(i=>i!==t):[...s,t])},se=async t=>{if(!t.name.trim()){r.error("Test name is required");return}if(!t.price||parseFloat(t.price)<=0){r.error("Please enter a valid price");return}if(c.length===0){r.error("Please select at least one parameter");return}try{const s=await me({data:{name:t.name,price:t.price,parameterIds:c}});s.success?(r.success("Test created successfully"),E(),d([]),l("0.00"),u(!1),await C()):r.error(s.error||"Failed to create test")}catch(s){const i=s instanceof Error?s.message:"Failed to create test";console.error("Error creating test:",s),r.error(i)}},re=async t=>{if(!T){r.error("No test selected");return}if(!t.name.trim()){r.error("Test name is required");return}if(!t.price||parseFloat(t.price)<=0){r.error("Please enter a valid price");return}if(c.length===0){r.error("Please select at least one parameter");return}try{const s=await xe({data:{id:T.id,name:t.name,price:t.price,parameterIds:c}});s.success?(r.success("Test updated successfully"),_(),d([]),l("0.00"),y(!1),await C()):r.error(s.error||"Failed to update test")}catch(s){const i=s instanceof Error?s.message:"Failed to update test";console.error("Error updating test:",s),r.error(i)}},ae=async t=>{if(confirm("Are you sure you want to delete this test?"))try{const s=await ne({data:{id:t}});s.success?(r.success("Test deleted successfully"),await C()):r.error(s.error||"Failed to delete test")}catch(s){const i=s instanceof Error?s.message:"Failed to delete test";console.error("Error deleting test:",s),r.error(i)}},le=async t=>{if(!t.query.trim()){b([]),k(!1);return}k(!0);try{const s=await de({data:{query:t.query,limit:50,offset:0}});s.success?b(s.data):(r.error("Failed to search tests"),b([]))}catch(s){const i=s instanceof Error?s.message:"Failed to search tests";console.error("Error searching tests:",s),r.error(i),b([])}finally{k(!1)}},D=q.length>0?q:X;return e.jsx(ue,{children:e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Test Management"}),e.jsxs(n,{onClick:()=>{u(!0),d([]),l("0.00"),E()},className:"bg-blue-600 hover:bg-blue-700 text-white",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Add Test"]})]}),e.jsx("div",{className:"mb-6",children:e.jsxs("form",{onSubmit:te(le),className:"flex gap-2",children:[e.jsx("input",{type:"text",...ee("query"),placeholder:"Search tests...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-md text-sm"}),e.jsx(n,{type:"submit",className:"bg-gray-600 hover:bg-gray-700",children:e.jsx(ge,{className:"w-4 h-4"})})]})}),D.length===0?e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg p-8 text-center",children:[e.jsx(F,{className:"w-12 h-12 text-gray-400 mx-auto mb-3"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"No tests found"}),e.jsx(n,{onClick:()=>{u(!0),d([]),l("0.00"),E()},className:"bg-blue-600 hover:bg-blue-700 text-white",children:'Click "Add Test" to create one'})]}):e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg overflow-hidden",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{className:"bg-gray-50 border-b border-gray-200",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-900",children:"Test Name"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-900",children:"Price (₹)"}),e.jsx("th",{className:"px-4 py-3 text-left text-sm font-semibold text-gray-900",children:"Parameters"}),e.jsx("th",{className:"px-4 py-3 text-right text-sm font-semibold text-gray-900",children:"Actions"})]})}),e.jsx("tbody",{children:D.map(t=>{const i=(t.metadata?.parameterIds||[]).map(g=>m.find(x=>x.id===g)?.name||"Unknown").join(", ");return e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-3 text-sm text-gray-900",children:t.name}),e.jsxs("td",{className:"px-4 py-3 text-sm text-gray-700",children:["₹",t.price]}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-700",children:i||"-"}),e.jsxs("td",{className:"px-4 py-3 text-right",children:[e.jsx("button",{onClick:()=>{W(t);const g=t.metadata?.parameterIds||[];d(g),Q("name",t.name),Q("price",t.price),y(!0),(async()=>{if(g.length===0){l("0.00");return}try{const x=await z({data:{parameterIds:g}});x.success&&l(x.totalPrice)}catch(x){console.error("Error calculating price:",x)}})()},className:"text-blue-600 hover:text-blue-800 mr-3",children:e.jsx(ye,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>ae(t.id),className:"text-red-600 hover:text-red-800",children:e.jsx(be,{className:"w-4 h-4"})})]})]},t.id)})})]})}),J&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white border border-gray-400 max-w-3xl w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-300 bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Add Test Bundle"}),e.jsx(n,{variant:"destructive",onClick:()=>{u(!1),d([]),l("0.00")},className:"p-1",children:e.jsx(U,{className:"w-4 h-4"})})]}),e.jsxs("form",{onSubmit:Y(se),className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Test Name *"}),e.jsx("input",{type:"text",...L("name",{required:"Test name is required"}),className:"w-full px-3 py-2 border border-gray-300 text-sm"}),w.name&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:w.name.message})]}),e.jsxs("div",{children:[e.jsx(h,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Price (₹) *"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",...L("price",{required:"Price is required"}),className:"flex-1 px-3 py-2 border border-gray-300 text-sm",placeholder:`Calculated: ${N}`})}),w.price&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:w.price.message}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Calculated: ₹",N]})]})]}),e.jsxs("div",{className:"border-t border-gray-300 pt-4",children:[e.jsxs(h,{className:"block text-sm font-medium text-gray-900 mb-2",children:["Select Parameters (",c.length," selected)"]}),f&&e.jsxs("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm flex items-start gap-2",children:[e.jsx(F,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:f}),e.jsx("button",{type:"button",onClick:$,className:"text-red-600 hover:text-red-800 underline",children:"Try loading parameters again"})]})]}),e.jsx("input",{type:"text",placeholder:"Search parameters...",value:p,onChange:t=>I(t.target.value),className:"w-full px-3 py-2 border border-gray-300 text-sm mb-3"}),e.jsx("div",{className:"border border-gray-300 max-h-64 overflow-y-auto",children:v.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:m.length===0?"No parameters available. Please create test parameters first.":"No parameters match your search"}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900 w-12",children:"Select"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Parameter"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Unit"}),e.jsx("th",{className:"px-3 py-2 text-right font-semibold text-gray-900",children:"Price"})]})}),e.jsx("tbody",{children:v.map(t=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 cursor-pointer",onClick:()=>P(t.id),children:[e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.includes(t.id),onChange:()=>P(t.id),className:"w-4 h-4"})}),e.jsx("td",{className:"px-3 py-2 text-gray-900",children:t.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:t.unit||"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-900",children:t.price?`₹${t.price}`:"-"})]},t.id))})]})})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(n,{type:"button",variant:"destructive",onClick:()=>{u(!1),d([]),l("0.00")},className:"flex-1 px-3 py-2 text-sm",children:"Cancel"}),e.jsx(n,{type:"submit",disabled:O,className:"flex-1 px-3 py-2 text-sm",children:O?"Adding...":"Add Test"})]})]})]})}),K&&T&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto",children:e.jsxs("div",{className:"bg-white border border-gray-400 max-w-3xl w-full my-8",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-gray-300 bg-gray-50",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Edit Test Bundle"}),e.jsx(n,{onClick:()=>{y(!1),d([]),l("0.00")},className:"p-1 bg-white border border-gray-400",children:e.jsx(U,{className:"w-4 h-4"})})]}),e.jsxs("form",{onSubmit:Z(re),className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx(h,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Test Name *"}),e.jsx("input",{type:"text",...R("name",{required:"Test name is required"}),className:"w-full px-3 py-2 border border-gray-300 text-sm"}),S.name&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:S.name.message})]}),e.jsxs("div",{children:[e.jsx(h,{className:"block text-sm font-medium text-gray-900 mb-1",children:"Price (₹) *"}),e.jsx("div",{className:"flex gap-2",children:e.jsx("input",{type:"text",...R("price",{required:"Price is required"}),className:"flex-1 px-3 py-2 border border-gray-300 text-sm",placeholder:`Calculated: ${N}`})}),S.price&&e.jsx("p",{className:"text-red-600 text-xs mt-1",children:S.price.message}),e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Calculated: ₹",N]})]})]}),e.jsxs("div",{className:"border-t border-gray-300 pt-4",children:[e.jsxs(h,{className:"block text-sm font-medium text-gray-900 mb-2",children:["Select Parameters (",c.length," selected)"]}),f&&e.jsxs("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 rounded text-red-700 text-sm flex items-start gap-2",children:[e.jsx(F,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium mb-1",children:f}),e.jsx("button",{type:"button",onClick:$,className:"text-red-600 hover:text-red-800 underline",children:"Try loading parameters again"})]})]}),e.jsx("input",{type:"text",placeholder:"Search parameters...",value:p,onChange:t=>I(t.target.value),className:"w-full px-3 py-2 border border-gray-300 text-sm mb-3"}),e.jsx("div",{className:"border border-gray-300 max-h-64 overflow-y-auto",children:v.length===0?e.jsx("div",{className:"p-4 text-center text-gray-500",children:m.length===0?"No parameters available. Please create test parameters first.":"No parameters match your search"}):e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 sticky top-0",children:e.jsxs("tr",{className:"border-b border-gray-300",children:[e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900 w-12",children:"Select"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Parameter"}),e.jsx("th",{className:"px-3 py-2 text-left font-semibold text-gray-900",children:"Unit"}),e.jsx("th",{className:"px-3 py-2 text-right font-semibold text-gray-900",children:"Price"})]})}),e.jsx("tbody",{children:v.map(t=>e.jsxs("tr",{className:"border-b border-gray-200 hover:bg-gray-50 cursor-pointer",onClick:()=>P(t.id),children:[e.jsx("td",{className:"px-3 py-2 text-center",children:e.jsx("input",{type:"checkbox",checked:c.includes(t.id),onChange:()=>P(t.id),className:"w-4 h-4"})}),e.jsx("td",{className:"px-3 py-2 text-gray-900",children:t.name}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:t.unit||"-"}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-900",children:t.price?`₹${t.price}`:"-"})]},t.id))})]})})]}),e.jsxs("div",{className:"flex gap-2 mt-4",children:[e.jsx(n,{type:"button",variant:"destructive",onClick:()=>{y(!1),d([]),l("0.00")},className:"flex-1 px-3 py-2 text-sm",children:"Cancel"}),e.jsx(n,{type:"submit",disabled:V,className:"flex-1 px-3 py-2 text-sm",children:V?"Saving...":"Save Changes"})]})]})]})})]})})}export{ke as component};
