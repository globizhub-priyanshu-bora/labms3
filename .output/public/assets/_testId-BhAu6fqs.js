import{c as W,j as e,O as Z,w as ee,r as x,u as se,b as B,B as p,L as F,Q as te,S as ae}from"./main-7-PV94Mj.js";import{L as re}from"./Layout-BjyUM3rL.js";import{A as H}from"./arrow-left-OCQw69Ba.js";import{P as ne}from"./printer-B2_J5kfY.js";const le=[["path",{d:"M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2z",key:"1c8476"}],["path",{d:"M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7",key:"1ydtos"}],["path",{d:"M7 3v4a1 1 0 0 0 1 1h7",key:"t51u73"}]],ie=W("save",le);function _(t,n){if(!t||t.length===0)return null;const{age:a,gender:i}=n,c=r=>{if(!a)return!0;if(r.ageGroup==="custom"){const m=r.minAge??0,N=r.maxAge??150;return a>=m&&a<=N}switch(r.ageGroup){case"child":return a>=0&&a<=12;case"teen":return a>=13&&a<=19;case"adult":return a>=20&&a<=64;case"senior":return a>=65;default:return!0}},f=r=>!i||r.gender==="Any"?!0:r.gender===i,u=t.find(r=>c(r)&&f(r));if(u)return u;const g=t.find(r=>c(r)&&r.gender==="Any");if(g)return g;if(a&&a>=20&&a<=64){const r=t.find(m=>m.ageGroup==="adult"&&f(m));if(r)return r}const y=t.find(r=>r.ageGroup==="adult"&&r.gender==="Any");return y||t[0]}function de(t,n){if(!t||!n)return!1;const a=parseFloat(t);if(isNaN(a))return!1;const i=parseFloat(n.minValue),c=parseFloat(n.maxValue);return a<i||a>c}function ce(t,n){if(!t||!n)return null;const a=parseFloat(t);if(isNaN(a))return null;const i=parseFloat(n.minValue),c=parseFloat(n.maxValue);return a<i?"Low":a>c?"High":"Normal"}function $(t){return t?`${t.minValue} - ${t.maxValue}`:"-"}const o={name:"MEDICARE DIAGNOSTIC CENTER",tagline:"Accurate | Caring | Instant",address:"105-108, SMART VISION COMPLEX, HEALTHCARE ROAD, OPPOSITE HEALTHCARE COMPLEX, MUMBAI - 689578",phone:"0123456789",mobilePhone:"09123456789",email:"drlogy.pathlab@drlogy.com",website:"www.medicare.com",sampleCollection:{address:"125, Shivam Bungalow, S G Road, Mumbai"}};function oe(){const t=Z.useLoaderData(),n=ee(),a=x.useRef(null),[i,c]=x.useState(""),[f,u]=x.useState(!1),[g,y]=x.useState(null),[r,m]=x.useState(!1),[N,A]=x.useState(""),{register:G,handleSubmit:z,watch:U,setValue:T,formState:{isDirty:me}}=se();if(x.useEffect(()=>{if(t.data?.existingResult){const s=t.data.existingResult.result;s?.results&&s.results.forEach(l=>{T(`result_${l.parameterId}`,l.value)}),s?.impression&&c(s.impression)}},[t,T]),!t.success||!t.data)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx(B,{className:"w-16 h-16 text-red-500 mx-auto mb-4"}),e.jsx("p",{className:"text-xl text-gray-700 mb-4",children:"Test data not found"}),e.jsx(p,{onClick:()=>n({to:"/lab-management"}),children:"Back to Lab Management"})]})});const{patientTest:b,test:C,patient:d,doctor:X,bill:xe,parameters:v,existingResult:P}=t.data,L={age:d.age,gender:d.gender},w=s=>(typeof s=="string"?new Date(s):s).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}),R=s=>(typeof s=="string"?new Date(s):s).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0}),D=U(),E=Object.keys(D).some(s=>D[s]?.trim()),k=v.filter(s=>D[`result_${s.id}`]?.trim()).length,V=v.length,O=V>0?Math.round(k/V*100):0,q=async s=>{if(!E){A("Please enter at least one test result");return}m(!0),A("");try{const l=v.map(h=>{const S=s[`result_${h.id}`];if(!S?.trim())return null;const M=_(h.referenceRanges||[],L),Y=$(M),J=de(S,M,h.referenceRanges||[]),K=ce(S,M);return{parameterId:h.id,parameterName:h.name,value:S,unit:h.unit||"",referenceRange:Y,isAbnormal:J,status:K||void 0}}).filter(Boolean),j={patientTestId:b.id,results:l,impression:i.trim()||void 0};let I;P?I=await te({data:{id:P.id,...j}}):I=await ae({data:j}),I.success&&(y(l),u(!0))}catch(l){console.error("Error saving results:",l),A(l instanceof Error?l.message:"Failed to save results")}finally{m(!1)}},Q=()=>{window.print()};return f&&g?e.jsxs(e.Fragment,{children:[e.jsx("style",{children:`
          @media print {
            @page {
              size: A4;
              margin: 8mm;
            }
            body {
              margin: 0;
              padding: 0;
            }
            * {
              -webkit-print-color-adjust: exact !important;
              print-color-adjust: exact !important;
            }
            .no-print {
              display: none !important;
            }
            nav,
            header,
            .no-print,
            button,
            [role="button"],
            [class*="nav"],
            [class*="header"],
            [class*="menu"],
            [class*="sidebar"] {
              display: none !important;
              visibility: hidden !important;
            }
          }
        `}),e.jsxs("div",{className:"min-h-screen bg-gray-50 print:bg-white",children:[e.jsxs("div",{className:"fixed top-4 right-4 z-50 flex gap-2 no-print bg-white p-3 rounded-lg shadow-lg",children:[e.jsxs(p,{onClick:()=>u(!1),className:"px-4 py-2 bg-gray-600 hover:bg-gray-700",children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Back to Edit"]}),e.jsxs(p,{onClick:Q,className:"px-4 py-2 bg-blue-600 hover:bg-blue-700",children:[e.jsx(ne,{className:"w-4 h-4 mr-2"}),"Print Report"]})]}),e.jsx("div",{className:"pt-20 pb-8 print:pt-0 print:pb-0",children:e.jsxs("div",{ref:a,className:"max-w-[210mm] mx-auto bg-white p-8 print:p-4 shadow-lg print:shadow-none",children:[e.jsx("div",{className:"border-4 border-blue-600 mb-3",children:e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-blue-800 text-white px-4 py-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h1",{className:"text-2xl font-bold tracking-wide",children:o.name}),e.jsx("p",{className:"text-xs mt-1 font-medium",children:o.tagline}),e.jsx("p",{className:"text-[10px] mt-2 max-w-2xl leading-tight",children:o.address})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:"bg-white text-blue-700 px-3 py-1.5 rounded font-bold text-xs",children:["��� ",o.phone]})})]}),e.jsxs("div",{className:"flex justify-between text-[9px] mt-2 border-t border-blue-400 pt-1.5",children:[e.jsxs("span",{children:["��� ",o.email]}),e.jsxs("span",{children:["��� ",o.website]})]})]})}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 mb-3 text-xs",children:[e.jsxs("div",{className:"border border-gray-300 p-2.5",children:[e.jsx("h3",{className:"font-bold mb-1.5 text-sm text-gray-800",children:d.name}),e.jsxs("div",{className:"space-y-0.5 text-[10px]",children:[e.jsxs("p",{className:"text-gray-700",children:["Age: ",e.jsxs("span",{className:"font-semibold",children:[d.age||"N/A"," Years"]})]}),e.jsxs("p",{className:"text-gray-700",children:["Sex: ",e.jsx("span",{className:"font-semibold",children:d.gender||"N/A"})]}),e.jsxs("p",{className:"text-gray-700",children:["PID: ",e.jsx("span",{className:"font-semibold",children:d.id})]})]})]}),e.jsxs("div",{className:"border border-gray-300 p-2.5",children:[e.jsx("h3",{className:"font-bold mb-1.5 text-[11px] text-gray-800",children:"Sample Collected At:"}),e.jsx("p",{className:"text-gray-700 text-[9px] leading-tight mb-2",children:o.sampleCollection.address}),e.jsxs("p",{className:"text-gray-700 text-[10px]",children:["Ref. By: ",e.jsx("span",{className:"font-semibold",children:X?.name||"N/A"})]})]}),e.jsx("div",{className:"border border-gray-300 p-2.5",children:e.jsxs("div",{className:"space-y-1 text-[9px]",children:[e.jsxs("p",{className:"text-gray-700",children:[e.jsx("span",{className:"font-semibold",children:"Registered on:"})," ",w(b.createdAt)," ",R(b.createdAt)]}),e.jsxs("p",{className:"text-gray-700",children:[e.jsx("span",{className:"font-semibold",children:"Collected on:"})," ",w(b.createdAt)," ",R(b.createdAt)]}),e.jsxs("p",{className:"text-gray-700",children:[e.jsx("span",{className:"font-semibold",children:"Reported on:"})," ",w(new Date)," ",R(new Date)]})]})})]}),e.jsx("div",{className:"bg-gray-100 border-t-2 border-b-2 border-gray-800 py-1.5 px-4 mb-3",children:e.jsx("h2",{className:"text-base font-bold text-center text-gray-900",children:C.name})}),e.jsxs("table",{className:"w-full border-collapse mb-3 text-[10px]",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"bg-gray-100",children:[e.jsx("th",{className:"border border-gray-300 px-3 py-1.5 text-left font-bold text-gray-800",children:"Parameter"}),e.jsx("th",{className:"border border-gray-300 px-3 py-1.5 text-center font-bold text-gray-800",children:"Result"}),e.jsx("th",{className:"border border-gray-300 px-3 py-1.5 text-center font-bold text-gray-800",children:"Reference Value"}),e.jsx("th",{className:"border border-gray-300 px-3 py-1.5 text-center font-bold text-gray-800",children:"Unit"})]})}),e.jsxs("tbody",{children:[e.jsx("tr",{className:"bg-blue-50 border-b-2 border-blue-400",children:e.jsxs("td",{colSpan:4,className:"border border-gray-300 px-3 py-1.5 text-[10px] font-bold text-blue-900",children:[C.name," - Primary Sample Type: Serum"]})}),g.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50",children:[e.jsx("td",{className:"border border-gray-300 px-3 py-1.5 text-gray-800",children:s.parameterName}),e.jsxs("td",{className:`border border-gray-300 px-3 py-1.5 text-center font-semibold ${s.status==="High"?"text-red-600":s.status==="Low"?"text-blue-600":"text-gray-800"}`,children:[s.value||"-",s.status&&s.status!=="Normal"&&e.jsxs("span",{className:"ml-1.5 text-[9px] font-bold",children:["(",s.status,")"]})]}),e.jsx("td",{className:"border border-gray-300 px-3 py-1.5 text-center text-gray-700",children:s.referenceRange||"-"}),e.jsx("td",{className:"border border-gray-300 px-3 py-1.5 text-center text-gray-700",children:s.unit||"-"})]},s.parameterId))]})]}),i&&e.jsxs("div",{className:"mb-3",children:[e.jsx("h3",{className:"text-[11px] font-bold text-gray-900 mb-2",children:"Clinical Impression / Notes:"}),e.jsx("div",{className:"border border-gray-300 p-2.5 text-[10px] text-gray-700 whitespace-pre-wrap break-words",children:i})]}),e.jsxs("div",{className:"mt-6 grid grid-cols-3 gap-4",children:[e.jsx("div",{}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"h-10 flex items-end justify-center",children:e.jsx("div",{className:"text-sm italic text-gray-600",children:"Dr. Vimal Shah"})})}),e.jsx("p",{className:"font-bold text-[10px] text-gray-800",children:"Dr. Vimal Shah"}),e.jsx("p",{className:"text-gray-600 text-[8px]",children:"(MD, Pathologist)"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:e.jsx("div",{className:"h-10 flex items-end justify-center",children:e.jsx("div",{className:"text-sm italic text-gray-600",children:"Dr. Vimal Shah"})})}),e.jsx("p",{className:"font-bold text-[10px] text-gray-800",children:"Dr. Vimal Shah"}),e.jsx("p",{className:"text-gray-600 text-[8px]",children:"(MD, Pathologist)"})]})]}),e.jsxs("div",{className:"bg-gradient-to-r from-blue-600 to-blue-800 text-white py-2 px-4 flex justify-between items-center text-[9px] mt-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{children:"��� Sample Collection"}),e.jsxs("span",{className:"font-bold",children:["��� ",o.mobilePhone]})]}),e.jsxs("div",{children:[e.jsxs("span",{children:["Generated on: ",w(new Date)," ",R(new Date)]}),e.jsx("span",{className:"ml-4",children:"Page 1 of 1"})]})]})]})})]})]}):e.jsx("div",{className:"min-h-screen bg-gray-50",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-6 py-8",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Test Result Entry"}),e.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:["Patient: ",e.jsx("span",{className:"font-semibold",children:d.name})," | Test: ",e.jsx("span",{className:"font-semibold",children:C.name})]}),d.age&&d.gender&&e.jsxs("p",{className:"text-xs text-blue-600 mt-1",children:["Reference ranges are automatically selected based on patient's age (",d.age," years) and gender (",d.gender,")"]})]}),e.jsxs(p,{onClick:()=>n({to:"/lab-management"}),className:"px-4 py-2",children:[e.jsx(H,{className:"w-4 h-4 mr-2"}),"Back to Lab"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Completion Progress"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:[k," / ",V," (",O,"%)"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-600 h-2 rounded-full transition-all duration-300",style:{width:`${O}%`}})})]}),N&&e.jsx("div",{className:"mb-4 bg-red-50 border border-red-200 rounded-lg p-3",children:e.jsx("p",{className:"text-sm text-red-800",children:N})})]}),e.jsxs("form",{onSubmit:z(q),children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Test Parameters"}),e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:v.map(s=>{const l=_(s.referenceRanges||[],L),j=$(l);return e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"flex justify-between items-start mb-3",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(F,{className:"text-base font-semibold text-gray-900",children:s.name}),s.unit&&e.jsxs("p",{className:"text-xs text-gray-600 mt-1",children:["Unit: ",s.unit]})]}),j&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-gray-600 font-semibold",children:"Reference"}),e.jsx("p",{className:"text-xs text-blue-600 font-bold",children:j})]})]}),e.jsx("input",{type:"text",...G(`result_${s.id}`),placeholder:"Enter result value",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"})]},s.id)})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[e.jsx(F,{className:"block text-lg font-semibold text-gray-900 mb-3",children:"Clinical Impression / Notes"}),e.jsx("textarea",{value:i,onChange:s=>c(s.target.value),rows:8,className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none",placeholder:"Enter clinical impression, observations, recommendations, or any relevant notes here..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"Optional: Add any clinical observations or recommendations"})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx(p,{type:"button",onClick:()=>n({to:"/lab-management"}),className:"flex-1 px-6 py-3 bg-gray-600 hover:bg-gray-700",children:"Cancel"}),e.jsxs(p,{type:"submit",disabled:r||!E,className:"flex-1 px-6 py-3 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(ie,{className:"w-5 h-5 mr-2"}),r?"Saving...":P?"Update & Preview Report":"Save & Preview Report"]})]}),!E&&e.jsx("div",{className:"mt-4 bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:e.jsxs("p",{className:"text-sm text-yellow-800",children:[e.jsx(B,{className:"w-4 h-4 inline mr-2"}),"Please enter at least one test result to save and generate the report."]})})]})]})})}const be=()=>e.jsx(re,{requiredRole:["admin","lab_tech"],children:e.jsx(oe,{})});export{be as component};
